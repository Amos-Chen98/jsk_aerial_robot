<?xml version="1.0"?>
<robot
    xmlns:xacro="http://www.ros.org/wiki/xacro" name="hydrus3_link" >

  <!-- problem: the direction of the link is opposite, because the joint!! -->
  <xacro:macro name="hydrus3_link" params="self child head tail imu">

    <xacro:if value="${head}">
      <link name="link${self}">
        <xacro:link_model self="1" />
        <!-- TODO: check precise inertial -->
        <inertial>
          <origin xyz="0 0 0" rpy="0 0 0"/>
          <mass value="0.5"/>
          <inertia
              ixx="0.1" ixy="0.0" ixz="0.0"
              iyy="0.01" iyz="0.0"
              izz="0.11"/>
        </inertial>
      </link>

      <joint name="joint${self}" type="revolute">
        <limit effort="100.0" lower="-1.57" upper="1.57" velocity="0.5"/>
        <parent link="link${self}"/>
        <child link="joint${self}"/>
        <origin rpy="0 0 0" xyz="-${link_length*.5} 0 0"/>
        <axis xyz="0 0 1"/>
        <dynamics damping="0.8"/>
      </joint>

      <link name="joint${self}">
        <collision>
          <origin rpy="0 0 0" xyz="0 0 0"/>
          <geometry>
            <cylinder length="0.05" radius="0.02"/>
          </geometry>
        </collision>
        <visual>
          <origin rpy="0 0 0" xyz="0 0 0"/>
          <geometry>
            <cylinder length="0.001" radius="0.001"/>
          </geometry>
          <material name="color">
            <color rgba="0.75 .5 .2 1"/>
          </material>
        </visual>
        <inertial>
          <origin rpy="0 0 0" xyz="0 0 0"/>
          <mass value="0.1"/>
          <inertia ixx="0.00005" ixy="0.0" ixz="0.0" iyy="0.00005" iyz="0.0" izz="0.0001"/>
        </inertial>
      </link>

      <joint name="joint${self}_link${child}" type="fixed">
        <parent link="joint${self}"/>
        <child link="link${child}"/>
        <origin rpy="0 0 0" xyz="-${link_length*.5} 0 0"/>
      </joint>

    </xacro:if> <!-- var_head -->
    <xacro:unless value="${head}">
      <xacro:if value="${tail}">
        <link name="link${self}">

          <xacro:link_model self="4" />
          <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="0.5"/>
            <inertia
                ixx="0.1" ixy="0.0" ixz="0.0"
                iyy="0.01" iyz="0.0"
                izz="0.11"/>
          </inertial>
        </link>

      </xacro:if> <!-- var_tail -->
      <xacro:unless value="${tail}">
        <xacro:if value="${imu}">
          <link name="link${self}">
            <xacro:link_model self="2" />
            <inertial>
              <origin xyz="0 0 0" rpy="0 0 0"/>
              <mass value="0.5"/>
              <inertia
                  ixx="0.1" ixy="0.0" ixz="0.0"
                  iyy="0.01" iyz="0.0"
                  izz="0.11"/>
            </inertial>
          </link>

        </xacro:if> <!-- var_imu -->
        <xacro:unless value="${imu}"> <!-- var_imu -->

          <link name="link${self}">
            <xacro:link_model self="3" />
            <inertial>
              <origin xyz="0 0 0" rpy="0 0 0"/>
              <mass value="0.5"/>
              <inertia
                  ixx="0.1" ixy="0.0" ixz="0.0"
                  iyy="0.01" iyz="0.0"
                  izz="0.11"/>
            </inertial>
          </link>

        </xacro:unless> <!-- var_imu -->
        <joint name="joint${self}" type="revolute">
          <limit effort="100.0" lower="-1.57" upper="1.57" velocity="0.5"/>
          <parent link="link${self}"/>
          <child link="joint${self}"/>
          <origin rpy="0 0 0" xyz="-${link_length*.5} 0 0"/>
          <axis xyz="0 0 1"/>
          <dynamics damping="0.7"/>
        </joint>

        <link name="joint${self}">
          <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <cylinder length="0.05" radius="0.02"/>
            </geometry>
          </collision>
          <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <cylinder length="0.001" radius="0.001"/>
            </geometry>
            <material name="color">
              <color rgba="0.75 .5 .2 1"/>
            </material>
          </visual>
          <inertial>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <mass value="0.1"/>
            <inertia ixx="0.00005" ixy="0.0" ixz="0.0" iyy="0.00005" iyz="0.0" izz="0.0001"/>
          </inertial>
        </link>

        <joint name="joint${self}_link${child}" type="fixed">
          <parent link="joint${self}"/>
          <child link="link${child}"/>
          <origin rpy="0 0 0" xyz="-${link_length*.5} 0 0"/>
        </joint>

      </xacro:unless> <!-- var_tail -->

    </xacro:unless> <!-- var_head -->

    <!-- hardware interface -->
    <xacro:unless value="${tail}">
      <transmission name="joint_tran${self}">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="joint${self}">
          <!-- TODO: effort is torque, maybe position is enough -->
          <hardwareInterface>EffortJointInterface</hardwareInterface>
        </joint>
        <actuator name="servo{self}">
          <!-- TODO: effort is torque, maybe position is enough -->
          <hardwareInterface>EffortJointInterface</hardwareInterface>
          <mechanicalReduction>1</mechanicalReduction>
        </actuator>
      </transmission>
    </xacro:unless> <!-- var_tail -->
  </xacro:macro>

</robot>
